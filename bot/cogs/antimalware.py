import logging

from discord import Message, utils
from discord.ext.commands import Bot, Cog

from bot.constants import AntiMalware as AntiMalwareConfig, Channels

log = logging.getLogger(__name__)


class AntiMalware(Cog):
    """Cog providing anti-malware behavior."""
    def __init__(self, bot: Bot):
        self.bot = bot
        self.whitelist = tuple(AntiMalwareConfig.whitelist)

    @Cog.listener()
    async def on_message(self, message: Message) -> None:
        """Identify messages with prohibited attachments."""
        log.trace("Entered AntiMalware.on_message()")
        rejected_attachments = [a for a in message.attachments if
                                not a.filename.lower().endswith(self.whitelist)]
        detected_pyfile = len([a for a in message.attachments if a.filename.lower().endswith('.py')]) > 0

        if len(rejected_attachments) > 0:
            log.trace("Identified rejected attachment(s)")
            # Send a message indicating the problem to the user (with special treatment for .py)
            author = message.author
            if detected_pyfile:
                msg = f"{author.mention}, it looks like you tried to attach a Python file - please " \
                    f"use a code-pasting service such as https://paste.pythondiscord.com/ instead."
            else:
                meta_channel = utils.get(message.guild.channels, id=Channels.meta)
                msg = f"{author.mention}, it looks like you tried to attach a file type we don't " \
                    f"allow. Feel free to ask in {meta_channel.mention} if you think this is a mistake."

            await message.channel.send(msg)


def setup(bot: Bot) -> None:
    """AntiMalware cog load."""
    bot.add_cog(AntiMalware(bot))
    log.info("Cog loaded: AntiMalware")
